// events/messageCreate.js (GÃœNCELLEMELER YAPILDI - HATA YÃ–NETÄ°MÄ° EKLENDÄ°)
const { PREFIX, OWNER_ID, UPLOADER_ROLE_ID, TRANSLATOR_ROLE_ID, MENULU_ROL_CHANNEL_ID, ADAM_ASMACA_CREATE_ROOM_CHANNEL_ID } = require('../utils/config');
const { getSystemSettings, saveSystemSettings, getBotStats, saveBotStats, getAnimes } = require('../utils/db');
const { EmbedBuilder, ChannelType, ActionRowBuilder, StringSelectMenuBuilder } = require('discord.js');
const os = require('os');
const { startNewsChecker, stopNewsChecker, getCurrentNewsJob, RSS_FEEDS } = require('../utils/newsChecker');
const { sendOrUpdateRoleMenu, disableRoleMenu, ROLES_INFO } = require('../utils/menuluRolUtils');
const hangmanManager = require('../utils/hangmanManager');

module.exports = {
    name: 'messageCreate',
    async execute(message, client) {
        if (message.author.bot || !message.guild) return;

        const content = message.content.toLowerCase();
        let settings = getSystemSettings(); 

        const checkPermission = (member, requiredRoleIDs, ownerId) => {
            return member.user.id === ownerId || requiredRoleIDs.some(roleId => member.roles.cache.has(roleId));
        };

        // ---------------------- PREFIX KOMUTLARI ----------------------
        if (message.content.startsWith(PREFIX)) {
            const args = message.content.slice(PREFIX.length).trim().split(/ +/);
            const commandName = args.shift().toLowerCase();

            try { // TÃ¼m prefix komutlarÄ±nÄ± bir try-catch bloÄŸuna alÄ±yoruz
                const botStats = getBotStats();
                botStats.commandsUsed++;
                saveBotStats(botStats);

                // Adam Asmaca Sistem KontrolÃ¼: Bu komutlar her zaman Ã§alÄ±ÅŸmalÄ±
                if (commandName === 'adam-asmaca-ac') {
                    if (message.author.id !== OWNER_ID) {
                        return message.reply({ content: 'Bu komutu sadece bot sahibi kullanabilir.' });
                    }
                    hangmanManager.setHangmanSystemStatus(true);
                    return message.reply('Adam Asmaca sistemi baÅŸarÄ±yla aÃ§Ä±ldÄ±!');
                }

                if (commandName === 'adam-asmaca-kapat') {
                    if (message.author.id !== OWNER_ID) {
                        return message.reply({ content: 'Bu komutu sadece bot sahibi kullanabilir.' });
                    }
                    hangmanManager.setHangmanSystemStatus(false);
                    return message.reply('Adam Asmaca sistemi baÅŸarÄ±yla kapatÄ±ldÄ±!');
                }

                // Adam Asmaca komutlarÄ± iÃ§in sistemin aktif olup olmadÄ±ÄŸÄ±nÄ± kontrol et
                if (!hangmanManager.getHangmanSystemStatus() && commandName.startsWith('adam-asmaca-') && commandName !== 'adam-asmaca-ac' && commandName !== 'adam-asmaca-kapat') {
                    if (message.author.id !== OWNER_ID) { 
                        return message.reply({ content: 'Adam Asmaca sistemi ÅŸu an kapalÄ±. LÃ¼tfen bir yetkilinin sistemi aÃ§masÄ±nÄ± bekleyin.' });
                    }
                }
                
                // Mevcut komutlar...
                if (commandName === 'sa-as') { 
                    if (args[0] === 'aÃ§' || args[0] === 'kapat') {
                        if (!checkPermission(message.member, [UPLOADER_ROLE_ID, TRANSLATOR_ROLE_ID], OWNER_ID)) {
                            return message.reply({ content: 'Bu komutu kullanmaya yetkiniz yok! YalnÄ±zca yetkili ekip Ã¼yeleri ve bot sahibi kullanabilir.' });
                        }
                        const newState = args[0] === 'aÃ§';
                        settings.saas.active = newState;
                        saveSystemSettings(settings);
                        return message.reply(`SelamÃ¼n AleykÃ¼m - AleykÃ¼m Selam sistemi baÅŸarÄ±yla ${newState ? 'aÃ§Ä±ldÄ±' : 'kapatÄ±ldÄ±'}!`);
                    } else {
                        return message.reply(`KullanÄ±m: \`${PREFIX}sa-as [aÃ§/kapat]\``);
                    }
                }

                if (commandName === 'gunaydin') {
                    if (args[0] === 'aÃ§' || args[0] === 'kapat') {
                        if (!checkPermission(message.member, [UPLOADER_ROLE_ID, TRANSLATOR_ROLE_ID], OWNER_ID)) {
                            return message.reply({ content: 'Bu komutu kullanmaya yetkiniz yok! YalnÄ±zca yetkili ekip Ã¼yeleri ve bot sahibi kullanabilir.' });
                        }
                        const newState = args[0] === 'aÃ§';
                        settings.gunaydin.active = newState;
                        saveSystemSettings(settings);
                        return message.reply(`GÃ¼naydÄ±n yanÄ±t sistemi baÅŸarÄ±yla ${newState ? 'aÃ§Ä±ldÄ±' : 'kapatÄ±ldÄ±'}!`);
                    } else {
                        return message.reply(`KullanÄ±m: \`${PREFIX}gunaydin [aÃ§/kapat]\``);
                    }
                }

                if (commandName === 'haber-sistemi') { 
                    if (!checkPermission(message.member, [OWNER_ID], OWNER_ID)) { 
                        return message.reply({ content: 'Bu komutu kullanmaya yetkiniz yok! YalnÄ±zca bot sahibi kullanabilir.' });
                    }

                    const action = args[0] ? args[0].toLowerCase() : null;

                    if (action === 'aÃ§' || action === 'ac') {
                        if (settings.haberSistemi.active) {
                            return message.reply('Haber sistemi zaten aktif!');
                        }
                        settings.haberSistemi.active = true;
                        saveSystemSettings(settings);
                        startNewsChecker(client); 
                        return message.reply('Haber sistemi baÅŸarÄ±yla aÃ§Ä±ldÄ±! Haberler artÄ±k dÃ¼zenli olarak kontrol edilecek.');
                    } else if (action === 'kapat') {
                        if (!settings.haberSistemi.active) {
                            return message.reply('Haber sistemi zaten kapalÄ±!');
                        }
                        settings.haberSistemi.active = false;
                        saveSystemSettings(settings);
                        stopNewsChecker(); 
                        return message.reply('Haber sistemi baÅŸarÄ±yla kapatÄ±ldÄ±! Yeni haberler gÃ¶nderilmeyecek.');
                    } else {
                        return message.reply(`KullanÄ±m: \`${PREFIX}haber-sistemi [aÃ§/kapat]\``);
                    }
                }

                if (commandName === 'haber-bilgi') { 
                    settings = getSystemSettings(); 

                    const isActive = settings.haberSistemi.active;
                    let lastCheckMessage;
                    let nextCheckMessage;

                    if (settings.haberSistemi.lastCheck) {
                        lastCheckMessage = `<t:${Math.floor(settings.haberSistemi.lastCheck / 1000)}:R>`; 
                    } else {
                        lastCheckMessage = 'HenÃ¼z hiÃ§ kontrol edilmedi.';
                    }

                    if (isActive) {
                        if (settings.haberSistemi.nextCheck) {
                            nextCheckMessage = `<t:${Math.floor(settings.haberSistemi.nextCheck / 1000)}:R>`; 
                        } else {
                            const now = new Date();
                            const nextHour = new Date(now.getFullYear(), now.getMonth(), now.getDate(), now.getHours() + 1, 0, 0);
                            nextCheckMessage = `YaklaÅŸÄ±k ${Math.ceil((nextHour.getTime() - Date.now()) / (1000 * 60))} dakika iÃ§inde.`;
                            if (nextHour.getTime() < Date.now()) { 
                                const nextNextHour = new Date(now.getFullYear(), now.getMonth(), now.getDate(), now.getHours() + 2, 0, 0);
                                nextCheckMessage = `YaklaÅŸÄ±k ${Math.ceil((nextNextHour.getTime() - Date.now()) / (1000 * 60))} dakika iÃ§inde.`;
                            }
                            nextCheckMessage += " (Ä°lk kontrol sonrasÄ± kesinleÅŸir)";
                        }
                    } else {
                        nextCheckMessage = 'Sistem kapalÄ±, zamanlanmÄ±ÅŸ kontrol yok.';
                    }

                    const embed = new EmbedBuilder()
                        .setColor(isActive ? '#00FF00' : '#FF0000')
                        .setTitle('Haber Sistemi Durumu')
                        .addFields(
                            { name: 'Durum', value: isActive ? 'âœ… Aktif' : 'âŒ KapalÄ±', inline: true },
{ name: 'Ã‡eviri Sistemi', value: 'âœ… Aktif' },
                            { name: 'Son Kontrol', value: lastCheckMessage, inline: true },
                            { name: 'Bir Sonraki Kontrol', value: nextCheckMessage, inline: true }
                            
                        );
                        
                    let rssSourcesField = '';
                    RSS_FEEDS.forEach((feed, index) => {
                        rssSourcesField += `${index + 1}. **${feed.name}**: Dil: ${feed.language.toUpperCase()}\n`;
                    });
                    embed.addFields({ name: 'KullanÄ±lan RSS KaynaklarÄ±', value: rssSourcesField, inline: false });

                    embed.setFooter({ text: 'SomeSub Bot', iconURL: client.user.displayAvatarURL() })
                        .setTimestamp();

                    await message.reply({ embeds: [embed] });
                    return;
                }

                if (commandName === 'menulu-rol') {
                    if (!checkPermission(message.member, [UPLOADER_ROLE_ID, TRANSLATOR_ROLE_ID], OWNER_ID)) {
                        return message.reply({ content: 'Bu komutu kullanmaya yetkiniz yok! YalnÄ±zca yetkili ekip Ã¼yeleri ve bot sahibi kullanabilir.' });
                    }

                    const action = args[0] ? args[0].toLowerCase() : null;

                    if (action === 'aÃ§' || action === 'ac') {
                        await sendOrUpdateRoleMenu(client, message, true); 
                    } else if (action === 'kapat') {
                        await disableRoleMenu(client, message);
                    } else {
                        return message.reply(`KullanÄ±m: \`${PREFIX}menulu-rol [aÃ§/kapat]\`\nNot: MenÃ¼ ${MENULU_ROL_CHANNEL_ID ? `<#${MENULU_ROL_CHANNEL_ID}>` : 'belirlenen kanala'} kurulur.`);
                    }
                    return;
                }

                if (commandName === 'menulu-rol-bilgi') {
                    if (message.author.id !== OWNER_ID) { 
                        return message.reply({ content: 'Bu komutu sadece bot sahibi kullanabilir.' });
                    }

                    const botStats = getBotStats();
                    settings = getSystemSettings(); 

                    const roleUsageData = botStats.roleUsage;

                    let roleStatsField = '';
                    if (ROLES_INFO.length > 0) {
                        ROLES_INFO.forEach(roleInfo => {
                            const count = roleUsageData[roleInfo.id] || 0;
                            roleStatsField += `${roleInfo.emoji} **${roleInfo.name}**: Verilme SayÄ±sÄ±: \`${count}\`\n`;
                        });
                    } else {
                        roleStatsField = 'Rol bilgileri bulunamadÄ± veya hiÃ§ rol ayarlanmamÄ±ÅŸ.';
                    }

                    const embed = new EmbedBuilder()
                        .setColor('#f8f9fa')
                        .setTitle('ğŸ“Š MenÃ¼lÃ¼ Rol Sistemi Ä°statistikleri')
                        .addFields(
                            { name: 'Durum', value: settings.menuluRolSistemi.active ? 'âœ… Aktif' : 'âŒ KapalÄ±', inline: true },
                            { name: 'Kanal', value: settings.menuluRolSistemi.channelId ? `<#${settings.menuluRolSistemi.channelId}>` : 'AyarlanmadÄ±', inline: true },
                            { name: 'Mesaj ID', value: settings.menuluRolSistemi.messageId || 'Yok', inline: true },
                            { name: 'Rol KullanÄ±m SayÄ±larÄ±', value: roleStatsField, inline: false }
                        )
                        .setFooter({ text: 'SomeSub Bot | GÃ¼ncel Veri', iconURL: client.user.displayAvatarURL() })
                        .setTimestamp();

                    await message.reply({ embeds: [embed] });
                    return;
                }

                if (commandName === 'istatistik') {
                    const developerId = OWNER_ID;
                    if (message.author.id !== developerId) {
                        return message.reply({ content: 'Bu komutu sadece geliÅŸtirici kullanabilir.' });
                    }

                    const totalMemory = os.totalmem();
                    const freeMemory = os.freemem();
                    const usedMemory = totalMemory - freeMemory;

                    const usedMemoryMB = (usedMemory / 1024 / 1024).toFixed(2);
                    const totalMemoryGB = (totalMemory / 1024 / 1024 / 1024).toFixed(2);
                    const ramUsage = `${usedMemoryMB}MB / ${totalMemoryGB}GB`;

                    const commandCount = client.commands.size; 

                    const botStats = getBotStats();
                    const ekliAnimeler = getAnimes().length;

                    const eklenenAnimeler = botStats.totalAnimesAdded;
                    const silinenAnimeler = botStats.totalAnimesRemoved;
                    const toplamKullanilanKomut = botStats.commandsUsed;
                    const sonGuncellemeTimestamp = botStats.lastUpdated;


                    const embed = new EmbedBuilder()
                        .setColor('#0099ff')
                        .setTitle('Somesub Bot Ä°statistikleri')
                        .setDescription('Botun anlÄ±k ve genel kullanÄ±m verileri.')
                        .addFields(
                            { name: 'GeliÅŸtirici', value: `<@${developerId}>`, inline: true },
                            { name: 'RAM KullanÄ±mÄ±', value: ramUsage, inline: true },
                            { name: 'YÃ¼klÃ¼ Komut SayÄ±sÄ±', value: `${commandCount}`, inline: true },
                            { name: 'Toplam Komut KullanÄ±mÄ±', value: `${toplamKullanilanKomut}`, inline: true },
                            { name: 'Ekli Animeler (Sistemde)', value: `${ekliAnimeler}`, inline: true },
                            { name: 'Eklenen Animeler (Toplam)', value: `${eklenenAnimeler}`, inline: true },
                            { name: 'Silinen Animeler (Toplam)', value: `${silinenAnimeler}`, inline: true },
                            { name: 'Son Veri GÃ¼ncelleme', value: `<t:${Math.floor(sonGuncellemeTimestamp / 1000)}:R>`, inline: true }
                        )
                        .setTimestamp()
                        .setFooter({ text: 'Somesub Fansub Bot', iconURL: client.user.displayAvatarURL() });

                    await message.reply({ embeds: [embed] });
                    return;
                }

                if (commandName === 'sistemler') { 
                    settings = getSystemSettings(); 

                    const sistemlerEmbed = new EmbedBuilder()
                        .setColor('#0099ff')
                        .setTitle('Aktif Sistem DurumlarÄ±')
                        .addFields(
                            { name: 'SelamÃ¼n AleykÃ¼m Sistemi', value: settings.saas.active ? 'âœ… AÃ§Ä±k' : 'âŒ KapalÄ±', inline: true },
                            { name: 'GÃ¼naydÄ±n Sistemi', value: settings.gunaydin.active ? 'âœ… AÃ§Ä±k' : 'âŒ KapalÄ±', inline: true },
                            { name: 'Haber Sistemi', value: settings.haberSistemi.active ? 'âœ… AÃ§Ä±k' : 'âŒ KapalÄ±', inline: true },
                            { name: 'MenÃ¼lÃ¼ Rol Sistemi', value: settings.menuluRolSistemi.active ? 'âœ… AÃ§Ä±k' : 'âŒ KapalÄ±', inline: true },
                            { name: 'Adam Asmaca Sistemi', value: hangmanManager.getHangmanSystemStatus() ? 'âœ… AÃ§Ä±k' : 'âŒ KapalÄ±', inline: true }
                        )
                        .setTimestamp()
                        .setFooter({ text: 'SomeSub Bot', iconURL: client.user.displayAvatarURL() });

                    await message.reply({ embeds: [sistemlerEmbed] });
                    return;
                }

                // --- YENÄ° ADAM ASMACA KOMUTLARI ---
                if (commandName === 'adam-asmaca-oda-olustur') {
                    if (message.channel.id !== ADAM_ASMACA_CREATE_ROOM_CHANNEL_ID) {
                        return message.reply(`Bu komutu sadece <#${ADAM_ASMACA_CREATE_ROOM_CHANNEL_ID}> kanalÄ±nda kullanabilirsiniz.`);
                    }

                    const type = args[0] ? args[0].toLowerCase() : null;
                    const maxPlayers = parseInt(args[1]);

                    if (!type || (type !== 'ozel' && type !== 'acik')) {
                        return message.reply('LÃ¼tfen oda tipini belirtin: `!adam-asmaca-oda-olustur [ozel/acik] [maksKisiSayisi]`');
                    }
                    if (isNaN(maxPlayers) || maxPlayers < 2 || maxPlayers > 10) { 
                        return message.reply('Maksimum oyuncu sayÄ±sÄ± en az 2, en fazla 10 olmalÄ±dÄ±r.');
                    }
                    
                    const existingRoomAsCreator = Array.from(hangmanManager.activeHangmanGames.values()).find(game => game.creatorId === message.author.id && game.status !== 'ended');
                    if (existingRoomAsCreator) {
                        return message.reply(`Zaten bir Adam Asmaca odasÄ± oluÅŸturdunuz veya aktif bir odanÄ±n kurucusunuz (Oda ID: \`${existingRoomAsCreator.id}\`). Yeni bir oda oluÅŸturmak iÃ§in Ã¶nce mevcut odanÄ±zÄ± bitirmelisiniz.`);
                    }
                    const newRoom = await hangmanManager.createHangmanRoom(message.member, type, maxPlayers, client);
                    if (newRoom) {
                        await message.reply(`Adam Asmaca odasÄ± baÅŸarÄ±yla oluÅŸturuldu! Oda ID: \`${newRoom.id}\`. Kanal: <#${newRoom.channelId}>`);
                    } else {
                        await message.reply('Oda oluÅŸturulurken bir hata oluÅŸtu. LÃ¼tfen bot sahibine bildirin.');
                    }
                    return;
                }

                if (commandName === 'adam-asmaca-davet-et') {
                    const game = Array.from(hangmanManager.activeHangmanGames.values()).find(g => g.creatorId === message.author.id && g.status === 'waiting');
                    if (!game) {
                        return message.reply('Sadece kendi oluÅŸturduÄŸunuz ve bekleme durumundaki bir odada davet gÃ¶nderebilirsiniz.');
                    }
                    if (game.type !== 'ozel') {
                        return message.reply('Bu komut sadece Ã¶zel odalar iÃ§in geÃ§erlidir.');
                    }
                    if (message.mentions.members.size === 0) {
                        return message.reply('LÃ¼tfen davet etmek istediÄŸiniz Ã¼yeleri etiketleyin.');
                    }

                    for (const member of message.mentions.members.values()) {
                        if (game.players.length >= game.maxPlayers) {
                            await message.reply(`Oda zaten dolu, ${member.user.username} davet edilemedi.`);
                            break;
                        }
                        if (game.players.some(p => p.id === member.id)) {
                            await message.reply(`${member.user.username} zaten odada.`);
                            continue;
                        }
                        if (member.user.bot) {
                            await message.reply('BotlarÄ± adam asmaca odasÄ±na davet edemezsiniz.');
                            continue;
                        }

                        const added = await hangmanManager.addPlayerToRoom(game.id, member, client);
                        if (added) {
                            await message.channel.send(`<@${member.id}> odaya davet edildi ve katÄ±ldÄ±!`);
                        } else {
                            await message.channel.send(`Hata: ${member.user.username} odaya eklenemedi.`);
                        }
                    }
                    return;
                }

                if (commandName === 'adam-asmaca-odalar') {
                    const openRooms = hangmanManager.listRooms('acik');
                    let embedDescription = '';

                    if (openRooms.length === 0) {
                        embedDescription = 'Åu anda aktif bir aÃ§Ä±k Adam Asmaca odasÄ± bulunmuyor.';
                    } else {
                        embedDescription = openRooms.map(room => 
                            `**ID:** \`${room.id}\` | **Kurucu:** <@${room.creatorId}> | **Oyuncular:** ${room.players.length}/${room.maxPlayers} | **Kanal:** <#${room.channelId}>`
                        ).join('\n');
                    }

                    const roomsEmbed = new EmbedBuilder()
                        .setColor('Green')
                        .setTitle('Aktif Adam Asmaca OdalarÄ±')
                        .setDescription(embedDescription)
                        .setFooter({ text: 'KatÄ±lmak iÃ§in !adam-asmaca-katÄ±l [ID]' })
                        .setTimestamp();

                    await message.reply({ embeds: [roomsEmbed] });
                    return;
                }

                if (commandName === 'adam-asmaca-katÄ±l') {
                    const roomId = args[0];
                    if (!roomId) {
                        return message.reply('LÃ¼tfen katÄ±lmak istediÄŸiniz odanÄ±n ID\'sini belirtin: `!adam-asmaca-katÄ±l [OdaID]`');
                    }

                    const game = hangmanManager.activeHangmanGames.get(roomId);
                    if (!game) {
                        return message.reply('Belirtilen ID\'ye sahip bir oda bulunamadÄ± veya kapalÄ±.');
                    }
                    if (game.type === 'ozel' && game.players.every(p => p.id !== message.author.id) && game.creatorId !== message.author.id) {
                        return message.reply('Bu Ã¶zel bir oda ve davetli deÄŸilsiniz.');
                    }
                    if (game.status !== 'waiting') {
                        return message.reply('Bu oda zaten baÅŸladÄ± veya bitmiÅŸ durumda.');
                    }
                    if (game.players.some(p => p.id === message.author.id)) {
                        return message.reply('Zaten bu odadasÄ±nÄ±z.');
                    }
                    if (game.players.length >= game.maxPlayers) {
                        return message.reply('Bu oda dolu.');
                    }

                    const added = await hangmanManager.addPlayerToRoom(roomId, message.member, client);
                    if (added) {
                        await message.reply(`\`${roomId}\` ID'li odaya baÅŸarÄ±yla katÄ±ldÄ±nÄ±z!`);
                    } else {
                        await message.reply('Odaya katÄ±lÄ±rken bir hata oluÅŸtu.');
                    }
                    return;
                }

                if (commandName === 'adam-asmaca-ayrÄ±l') {
                    const game = Array.from(hangmanManager.activeHangmanGames.values()).find(g => g.players.some(p => p.id === message.author.id) && g.status !== 'ended');
                    if (!game) {
                        return message.reply('Åu anda aktif bir Adam Asmaca odasÄ±nda deÄŸilsiniz.');
                    }

                    const removed = await hangmanManager.removePlayerFromRoom(game.id, message.author.id, client);
                    if (removed) {
                        await message.reply(`\`${game.id}\` ID'li odadan baÅŸarÄ±yla ayrÄ±ldÄ±nÄ±z.`);
                    } else {
                        await message.reply('Odadan ayrÄ±lÄ±rken bir hata oluÅŸtu.');
                    }
                    return;
                }

                if (commandName === 'adam-asmaca-at') {
                    const game = Array.from(hangmanManager.activeHangmanGames.values()).find(g => g.creatorId === message.author.id && g.status !== 'ended');
                    if (!game) {
                        return message.reply('Sadece kendi oluÅŸturduÄŸunuz odadan oyuncu atabilirsiniz.');
                    }
                    if (message.mentions.members.size === 0) {
                        return message.reply('LÃ¼tfen atmak istediÄŸiniz Ã¼yeyi etiketleyin.');
                    }
                    const targetMember = message.mentions.members.first();
                    if (targetMember.id === message.author.id) {
                        return message.reply('Kendinizi odadan atamazsÄ±nÄ±z, bunun yerine `!adam-asmaca-ayrÄ±l` komutunu kullanÄ±n.');
                    }
                    if (!game.players.some(p => p.id === targetMember.id)) {
                        return message.reply('Bu kiÅŸi odada deÄŸil.');
                    }

                    const removed = await hangmanManager.removePlayerFromRoom(game.id, targetMember.id, client, true);
                    if (removed) {
                        await message.reply(`${targetMember.user.username} baÅŸarÄ±yla odadan atÄ±ldÄ±.`);
                    } else {
                        await message.reply('Oyuncu atÄ±lÄ±rken bir hata oluÅŸtu.');
                    }
                    return;
                }

                if (commandName === 'adam-asmaca-baslat') {
                    const game = Array.from(hangmanManager.activeHangmanGames.values()).find(g => g.creatorId === message.author.id && g.status === 'waiting');
                    if (!game) {
                        return message.reply('Sadece kendi oluÅŸturduÄŸunuz ve bekleme durumundaki bir oyunu baÅŸlatabilirsiniz.');
                    }
                    if (game.players.length < 2) {
                        return message.reply(`Oyunu baÅŸlatmak iÃ§in en az 2 oyuncu olmalÄ±. Åu an: ${game.players.length}/${game.maxPlayers}`);
                    }
                
                    // Bu kÄ±sÄ±mdaki hatayÄ± yakalamak iÃ§in try-catch eklendi
                    try {
                        const started = await hangmanManager.startGame(game.id, client);
                        if (started) {
                            await message.reply(`Adam Asmaca oyunu baÅŸarÄ±yla baÅŸlatÄ±ldÄ±! Kelimeyi tahmin etmeye baÅŸlayÄ±n.`);
                        } else {
                            await message.reply('Oyunu baÅŸlatÄ±rken bir hata oluÅŸtu. LÃ¼tfen loglarÄ± kontrol edin veya bot sahibine bildirin.');
                        }
                    } catch (error) {
                        console.error(`Adam asmaca baÅŸlatÄ±lÄ±rken hata oluÅŸtu (game ID: ${game.id}):`, error);
                        await message.reply('Oyunu baÅŸlatÄ±rken beklenmedik bir hata oluÅŸtu. LÃ¼tfen bot sahibine bildirin.');
                    }
                    return;
                }
                
                // Bot sahibine Ã¶zel komutlar
                if (message.author.id === OWNER_ID) {
                    if (commandName === 'adam-asmaca-bilgi') {
                        const allRooms = hangmanManager.listRooms();
                        let infoDescription = 'Aktif Adam Asmaca OdalarÄ±:\n\n';
                        if (allRooms.length === 0) {
                            infoDescription = 'Åu anda aktif bir Adam Asmaca odasÄ± bulunmuyor.';
                        } else {
                            infoDescription += allRooms.map(room =>
                                `**ID:** \`${room.id}\` | **Kurucu:** <@${room.creatorId}> | **Tip:** ${room.type === 'ozel' ? 'Ã–zel' : 'AÃ§Ä±k'} | **Durum:** ${room.status} | **Oyuncular:** ${room.players.length}/${room.maxPlayers} | **Kanal:** <#${room.channelId}>${room.status === 'in_game' ? `\n**Kelime:** ${room.hiddenWord} | YanlÄ±ÅŸ: ${room.wrongGuesses}` : ''}`
                            ).join('\n\n');
                        }

                        const infoEmbed = new EmbedBuilder()
                            .setColor('Orange')
                            .setTitle('Adam Asmaca Sistemi Bilgisi')
                            .setDescription(infoDescription)
                            .setFooter({ text: 'SomeSub Bot | Sadece Bot Sahibi' })
                            .setTimestamp();
                        await message.reply({ embeds: [infoEmbed] });
                        return;
                    }

                    if (commandName === 'adam-asmaca-oda-kapat') {
                        const roomId = args[0];
                        if (!roomId) {
                            return message.reply('LÃ¼tfen kapatmak istediÄŸiniz odanÄ±n ID\'sini belirtin: `!adam-asmaca-oda-kapat [OdaID]`');
                        }
                        const closed = await hangmanManager.closeRoomAsOwner(roomId, client);
                        if (closed) {
                            await message.reply(`\`${roomId}\` ID'li oda baÅŸarÄ±yla kapatÄ±ldÄ±.`);
                        } else {
                            await message.reply('Belirtilen ID\'ye sahip bir oda bulunamadÄ± veya zaten kapalÄ±ydÄ±.');
                        }
                        return;
                    }
                }
            } catch (error) { // TÃ¼m prefix komutlarÄ±nÄ± kapsayan catch bloÄŸu
                console.error(`[MessageCreate] PREFIX Komutu Ã§alÄ±ÅŸtÄ±rÄ±lÄ±rken hata: ${commandName}`, error);
                if (message.replied || message.deferred) {
                    await message.followUp({ content: 'Bu komutu Ã§alÄ±ÅŸtÄ±rÄ±rken bir hata oluÅŸtu!', ephemeral: true });
                } else {
                    await message.reply({ content: 'Bu komutu Ã§alÄ±ÅŸtÄ±rÄ±rken bir hata oluÅŸtu! LÃ¼tfen bot sahibine bildirin.', ephemeral: true });
                }
            }
        }

        // ---------------------- KELÄ°ME TABANLI YANIT SÄ°STEMLERÄ° ----------------------
        // Bu kÄ±sÄ±m zaten try-catch iÃ§inde deÄŸil, ancak kritik bir hata durumu yaratmaz genelde.
        if (settings.saas.active) {
            const saasKeywords = [
                'sa', 'selamun aleykum', 'selamÃ¼n aleykÃ¼m', 'selamunaleykum', 'selam', 'selamlar', 'selamÃ¼naleykÃ¼m', 'sea'
            ];
            const isSaasMatch = saasKeywords.some(keyword => {
                return content === keyword || content.startsWith(keyword + ' ');
            });

            if (isSaasMatch) {
                await message.reply('AleykÃ¼mselam');
                return;
            }
        }

        if (settings.gunaydin.active) {
            const gunaydinKeywords = [
                'gÃ¼naydÄ±n', 'gunaydin', 'gÃ¼no', 'guno', 'gÃ¼naydÄ±nlar', 'gunaydinlar', 'aydÄ±nlar', 'aydÄ±nlÄ±k', 'iyi sabahlar'
            ];
            const isGunaydinMatch = gunaydinKeywords.some(keyword => {
                return content === keyword || content.startsWith(keyword + ' ');
            });

            if (isGunaydinMatch) {
                await message.reply('GÃ¼naydÄ±n! Kral');
                return;
            }
        }

        // YENÄ°: Adam Asmaca oyunu devam eden kanalda tahminleri yakala
        const activeGames = Array.from(hangmanManager.activeHangmanGames.values());
        const gameInChannel = activeGames.find(g => g.channelId === message.channel.id && g.status === 'in_game');

        if (gameInChannel && gameInChannel.currentPlayerId === message.author.id) {
            const guess = message.content.toLowerCase();
            // Tahmin butondan deÄŸil, doÄŸrudan mesajla geldiyse iÅŸle
            if (guess.length === 1 || guess.length > 1) { 
                try { // Tahmin iÅŸlemine de try-catch eklendi
                    const processed = await hangmanManager.handleGuess(gameInChannel.id, message.author.id, guess, client);
                    if (processed) {
                        await message.delete().catch(console.error); 
                    }
                } catch (error) {
                    console.error(`Adam asmaca tahmini iÅŸlenirken hata oluÅŸtu (game ID: ${gameInChannel.id}, user: ${message.author.tag}):`, error);
                    // KullanÄ±cÄ±yaEphemeral bir mesaj gÃ¶ndermeye gerek yok, sadece log tutabiliriz.
                }
            }
            return;
        } else if (gameInChannel && gameInChannel.players.some(p => p.id === message.author.id) && gameInChannel.currentPlayerId !== message.author.id) {
            // Sadece kendi sÄ±rasÄ± olmayan oyuncularÄ±n mesajlarÄ±nÄ± silmek iÃ§in
            await message.delete().catch(console.error);
            return;
        } else if (gameInChannel && !gameInChannel.players.some(p => p.id === message.author.id)) {
            // Oyunda olmayanlarÄ±n mesajlarÄ±nÄ± silmek iÃ§in
            await message.delete().catch(console.error);
            return;
        }
    },
};
